"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.init = init;
exports.registerIndie = registerIndie;

var _omni = require("../server/omni");

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _tsDisposables = require("ts-disposables");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Range = require("atom").Range;

function mapIndieValues(error) {
    var level = error.LogLevel.toLowerCase();
    return {
        type: level,
        text: error.Text + " [" + _omni.Omni.getFrameworks(error.Projects) + "] ",
        filePath: error.FileName,
        range: new Range([error.Line, error.Column], [error.EndLine, error.EndColumn])
    };
}
function showLinter() {
    _lodash2.default.each(document.querySelectorAll("linter-bottom-tab"), function (element) {
        element.style.display = "";
    });
    _lodash2.default.each(document.querySelectorAll("linter-bottom-status"), function (element) {
        element.style.display = "";
    });
    var panel = document.querySelector("linter-panel");
    if (panel) panel.style.display = "";
}
function hideLinter() {
    _lodash2.default.each(document.querySelectorAll("linter-bottom-tab"), function (element) {
        element.style.display = "none";
    });
    _lodash2.default.each(document.querySelectorAll("linter-bottom-status"), function (element) {
        element.style.display = "none";
    });
    var panel = document.querySelector("linter-panel");
    if (panel) panel.style.display = "none";
}
var showHiddenDiagnostics = true;
function init(linter) {
    var disposable = new _tsDisposables.CompositeDisposable();
    var cd = void 0;
    disposable.add(atom.config.observe("omnisharp-atom.hideLinterInterface", function (hidden) {
        if (hidden) {
            cd = new _tsDisposables.CompositeDisposable();
            disposable.add(cd);
            cd.add(_omni.Omni.activeEditor.filter(function (z) {
                return !z;
            }).subscribe(showLinter));
            cd.add(_omni.Omni.activeEditor.filter(function (z) {
                return !!z;
            }).subscribe(hideLinter));
        } else {
            if (cd) {
                disposable.remove(cd);
                cd.dispose();
            }
            showLinter();
        }
    }));
    disposable.add(atom.config.observe("omnisharp-atom.showHiddenDiagnostics", function (show) {
        showHiddenDiagnostics = show;
        atom.workspace.getTextEditors().forEach(function (editor) {
            var editorLinter = linter.getEditorLinter(editor);
            if (editorLinter) {
                editorLinter.lint(true);
            }
        });
    }));
    disposable.add(_omni.Omni.activeEditor.filter(function (z) {
        return !!z;
    }).take(1).delay(1000).subscribe(function (e) {
        _omni.Omni.whenEditorConnected(e).subscribe(function () {
            atom.workspace.getTextEditors().forEach(function (editor) {
                var editorLinter = linter.getEditorLinter(editor);
                if (editorLinter) {
                    editorLinter.lint(true);
                }
            });
        });
    }));
    return disposable;
}
function registerIndie(registry, disposable) {
    var linter = registry.register({ name: "c#" });
    disposable.add(linter, _omni.Omni.diagnostics.subscribe(function (diagnostics) {
        var messages = [];
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
            for (var _iterator = diagnostics[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var item = _step.value;

                if (showHiddenDiagnostics || item.LogLevel !== "Hidden") {
                    messages.push(mapIndieValues(item));
                }
            }
        } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion && _iterator.return) {
                    _iterator.return();
                }
            } finally {
                if (_didIteratorError) {
                    throw _iteratorError;
                }
            }
        }

        linter.setMessages(messages);
    }));
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9saW50ZXItcHJvdmlkZXIudHMiLCJsaWIvc2VydmljZXMvbGludGVyLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O1FBMERBO1FBa0RBOztBQzVHQTs7QUFFQTs7OztBQUNBOzs7O0FEQUEsSUFBTSxRQUFRLFFBQVEsTUFBUixFQUFnQixLQUFoQjs7QUEwQmQsU0FBQSxjQUFBLENBQXdCLEtBQXhCLEVBQXdEO0FBQ3BELFFBQU0sUUFBUSxNQUFNLFFBQU4sQ0FBZSxXQUFmLEVBQVIsQ0FEOEM7QUFHcEQsV0FBTztBQUNILGNBQU0sS0FBTjtBQUNBLGNBQVMsTUFBTSxJQUFOLFVBQWUsV0FBSyxhQUFMLENBQW1CLE1BQU0sUUFBTixRQUEzQztBQUNBLGtCQUFVLE1BQU0sUUFBTjtBQUNWLGVBQU8sSUFBSSxLQUFKLENBQVUsQ0FBQyxNQUFNLElBQU4sRUFBWSxNQUFNLE1BQU4sQ0FBdkIsRUFBc0MsQ0FBQyxNQUFNLE9BQU4sRUFBZSxNQUFNLFNBQU4sQ0FBdEQsQ0FBUDtLQUpKLENBSG9EO0NBQXhEO0FBV0EsU0FBQSxVQUFBLEdBQUE7QUFDSSxxQkFBRSxJQUFGLENBQU8sU0FBUyxnQkFBVCxDQUEwQixtQkFBMUIsQ0FBUCxFQUF1RCxVQUFDLE9BQUQsRUFBcUI7QUFBTyxnQkFBUSxLQUFSLENBQWMsT0FBZCxHQUF3QixFQUF4QixDQUFQO0tBQXJCLENBQXZELENBREo7QUFFSSxxQkFBRSxJQUFGLENBQU8sU0FBUyxnQkFBVCxDQUEwQixzQkFBMUIsQ0FBUCxFQUEwRCxVQUFDLE9BQUQsRUFBcUI7QUFBTyxnQkFBUSxLQUFSLENBQWMsT0FBZCxHQUF3QixFQUF4QixDQUFQO0tBQXJCLENBQTFELENBRko7QUFHSSxRQUFNLFFBQXFCLFNBQVMsYUFBVCxDQUF1QixjQUF2QixDQUFyQixDQUhWO0FBSUksUUFBSSxLQUFKLEVBQ0ksTUFBTSxLQUFOLENBQVksT0FBWixHQUFzQixFQUF0QixDQURKO0NBSko7QUFRQSxTQUFBLFVBQUEsR0FBQTtBQUNJLHFCQUFFLElBQUYsQ0FBTyxTQUFTLGdCQUFULENBQTBCLG1CQUExQixDQUFQLEVBQXVELFVBQUMsT0FBRCxFQUFxQjtBQUFNLGdCQUFRLEtBQVIsQ0FBYyxPQUFkLEdBQXdCLE1BQXhCLENBQU47S0FBckIsQ0FBdkQsQ0FESjtBQUVJLHFCQUFFLElBQUYsQ0FBTyxTQUFTLGdCQUFULENBQTBCLHNCQUExQixDQUFQLEVBQTBELFVBQUMsT0FBRCxFQUFxQjtBQUFNLGdCQUFRLEtBQVIsQ0FBYyxPQUFkLEdBQXdCLE1BQXhCLENBQU47S0FBckIsQ0FBMUQsQ0FGSjtBQUdJLFFBQU0sUUFBcUIsU0FBUyxhQUFULENBQXVCLGNBQXZCLENBQXJCLENBSFY7QUFJSSxRQUFJLEtBQUosRUFDSSxNQUFNLEtBQU4sQ0FBWSxPQUFaLEdBQXNCLE1BQXRCLENBREo7Q0FKSjtBQVFBLElBQUksd0JBQXdCLElBQXhCO0FBRUosU0FBQSxJQUFBLENBQXFCLE1BQXJCLEVBQXNIO0FBQ2xILFFBQU0sYUFBYSx3Q0FBYixDQUQ0RztBQUVsSCxRQUFJLFdBQUosQ0FGa0g7QUFHbEgsZUFBVyxHQUFYLENBQWUsS0FBSyxNQUFMLENBQVksT0FBWixDQUFvQixvQ0FBcEIsRUFBMEQsa0JBQU07QUFDM0UsWUFBSSxNQUFKLEVBQVk7QUFDUixpQkFBSyx3Q0FBTCxDQURRO0FBRVIsdUJBQVcsR0FBWCxDQUFlLEVBQWYsRUFGUTtBQUtSLGVBQUcsR0FBSCxDQUFPLFdBQUssWUFBTCxDQUNGLE1BREUsQ0FDSzt1QkFBSyxDQUFDLENBQUQ7YUFBTCxDQURMLENBRUYsU0FGRSxDQUVRLFVBRlIsQ0FBUCxFQUxRO0FBVVIsZUFBRyxHQUFILENBQU8sV0FBSyxZQUFMLENBQ0YsTUFERSxDQUNLO3VCQUFLLENBQUMsQ0FBQyxDQUFEO2FBQU4sQ0FETCxDQUVGLFNBRkUsQ0FFUSxVQUZSLENBQVAsRUFWUTtTQUFaLE1BYU87QUFDSCxnQkFBSSxFQUFKLEVBQVE7QUFDSiwyQkFBVyxNQUFYLENBQWtCLEVBQWxCLEVBREk7QUFFSixtQkFBRyxPQUFILEdBRkk7YUFBUjtBQUlBLHlCQUxHO1NBYlA7S0FEcUUsQ0FBekUsRUFIa0g7QUEwQmxILGVBQVcsR0FBWCxDQUFlLEtBQUssTUFBTCxDQUFZLE9BQVosQ0FBb0Isc0NBQXBCLEVBQTRELGdCQUFJO0FBQzNFLGdDQUF3QixJQUF4QixDQUQyRTtBQUUzRSxhQUFLLFNBQUwsQ0FBZSxjQUFmLEdBQWdDLE9BQWhDLENBQXdDLFVBQUMsTUFBRCxFQUFPO0FBQzNDLGdCQUFNLGVBQWUsT0FBTyxlQUFQLENBQXVCLE1BQXZCLENBQWYsQ0FEcUM7QUFFM0MsZ0JBQUksWUFBSixFQUFrQjtBQUNkLDZCQUFhLElBQWIsQ0FBa0IsSUFBbEIsRUFEYzthQUFsQjtTQUZvQyxDQUF4QyxDQUYyRTtLQUFKLENBQTNFLEVBMUJrSDtBQW9DbEgsZUFBVyxHQUFYLENBQWUsV0FBSyxZQUFMLENBQWtCLE1BQWxCLENBQXlCO2VBQUssQ0FBQyxDQUFDLENBQUQ7S0FBTixDQUF6QixDQUFtQyxJQUFuQyxDQUF3QyxDQUF4QyxFQUEyQyxLQUEzQyxDQUFpRCxJQUFqRCxFQUF1RCxTQUF2RCxDQUFpRSxVQUFDLENBQUQsRUFBRTtBQUM5RSxtQkFBSyxtQkFBTCxDQUF5QixDQUF6QixFQUE0QixTQUE1QixDQUFzQyxZQUFBO0FBQ2xDLGlCQUFLLFNBQUwsQ0FBZSxjQUFmLEdBQWdDLE9BQWhDLENBQXdDLFVBQUMsTUFBRCxFQUFPO0FBQzNDLG9CQUFNLGVBQWUsT0FBTyxlQUFQLENBQXVCLE1BQXZCLENBQWYsQ0FEcUM7QUFFM0Msb0JBQUksWUFBSixFQUFrQjtBQUNkLGlDQUFhLElBQWIsQ0FBa0IsSUFBbEIsRUFEYztpQkFBbEI7YUFGb0MsQ0FBeEMsQ0FEa0M7U0FBQSxDQUF0QyxDQUQ4RTtLQUFGLENBQWhGLEVBcENrSDtBQStDbEgsV0FBTyxVQUFQLENBL0NrSDtDQUF0SDtBQWtEQSxTQUFBLGFBQUEsQ0FBOEIsUUFBOUIsRUFBdUQsVUFBdkQsRUFBc0Y7QUFDbEYsUUFBTSxTQUFTLFNBQVMsUUFBVCxDQUFrQixFQUFFLE1BQU0sSUFBTixFQUFwQixDQUFULENBRDRFO0FBRWxGLGVBQVcsR0FBWCxDQUNJLE1BREosRUFFSSxXQUFLLFdBQUwsQ0FDSyxTQURMLENBQ2UsdUJBQVc7QUFDbEIsWUFBTSxXQUE0QixFQUE1QixDQURZOzs7Ozs7QUFFbEIsaUNBQWlCLHFDQUFqQixvR0FBOEI7b0JBQXJCLG1CQUFxQjs7QUFDMUIsb0JBQUkseUJBQXlCLEtBQUssUUFBTCxLQUFrQixRQUFsQixFQUE0QjtBQUNyRCw2QkFBUyxJQUFULENBQWMsZUFBZSxJQUFmLENBQWQsRUFEcUQ7aUJBQXpEO2FBREo7Ozs7Ozs7Ozs7Ozs7O1NBRmtCOztBQVFsQixlQUFPLFdBQVAsQ0FBbUIsUUFBbkIsRUFSa0I7S0FBWCxDQUhuQixFQUZrRjtDQUF0RiIsImZpbGUiOiJsaWIvc2VydmljZXMvbGludGVyLXByb3ZpZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtNb2RlbHN9IGZyb20gXCJvbW5pc2hhcnAtY2xpZW50XCI7XHJcbmltcG9ydCB7T21uaX0gZnJvbSBcIi4uL3NlcnZlci9vbW5pXCI7XHJcbi8qIHRzbGludDpkaXNhYmxlOnZhcmlhYmxlLW5hbWUgKi9cclxuY29uc3QgUmFuZ2UgPSByZXF1aXJlKFwiYXRvbVwiKS5SYW5nZTtcclxuLyogdHNsaW50OmVuYWJsZTp2YXJpYWJsZS1uYW1lICovXHJcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcclxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tIFwidHMtZGlzcG9zYWJsZXNcIjtcclxuXHJcbmludGVyZmFjZSBMaW50ZXJNZXNzYWdlIHtcclxuICAgIHR5cGU6IHN0cmluZzsgLy8gXCJlcnJvclwiIHwgXCJ3YXJuaW5nXCJcclxuICAgIHRleHQ/OiBzdHJpbmc7XHJcbiAgICBodG1sPzogc3RyaW5nO1xyXG4gICAgZmlsZVBhdGg/OiBzdHJpbmc7XHJcbiAgICByYW5nZT86IFJhbmdlO1xyXG4gICAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSW5kaWVSZWdpc3RyeSB7XHJcbiAgICByZWdpc3RlcihvcHRpb25zOiB7IG5hbWU6IHN0cmluZzsgfSk6IEluZGllO1xyXG4gICAgaGFzKGluZGllOiBhbnkpOiBCb29sZWFuO1xyXG4gICAgdW5yZWdpc3RlcihpbmRpZTogYW55KTogdm9pZDtcclxufVxyXG5cclxuaW50ZXJmYWNlIEluZGllIHtcclxuICAgIHNldE1lc3NhZ2VzKG1lc3NhZ2VzOiBMaW50ZXJNZXNzYWdlW10pOiB2b2lkO1xyXG4gICAgZGVsZXRlTWVzc2FnZXMoKTogdm9pZDtcclxuICAgIGRpc3Bvc2UoKTogdm9pZDtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFwSW5kaWVWYWx1ZXMoZXJyb3I6IE1vZGVscy5EaWFnbm9zdGljTG9jYXRpb24pOiBMaW50ZXJNZXNzYWdlIHtcclxuICAgIGNvbnN0IGxldmVsID0gZXJyb3IuTG9nTGV2ZWwudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHR5cGU6IGxldmVsLFxyXG4gICAgICAgIHRleHQ6IGAke2Vycm9yLlRleHR9IFske09tbmkuZ2V0RnJhbWV3b3JrcyhlcnJvci5Qcm9qZWN0cyl9XSBgLFxyXG4gICAgICAgIGZpbGVQYXRoOiBlcnJvci5GaWxlTmFtZSxcclxuICAgICAgICByYW5nZTogbmV3IFJhbmdlKFtlcnJvci5MaW5lLCBlcnJvci5Db2x1bW5dLCBbZXJyb3IuRW5kTGluZSwgZXJyb3IuRW5kQ29sdW1uXSlcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNob3dMaW50ZXIoKSB7XHJcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tdGFiXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHsgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gXCJcIjsgfSk7XHJcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHsgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gXCJcIjsgfSk7XHJcbiAgICBjb25zdCBwYW5lbCA9IDxIVE1MRWxlbWVudD5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwibGludGVyLXBhbmVsXCIpO1xyXG4gICAgaWYgKHBhbmVsKVxyXG4gICAgICAgIHBhbmVsLnN0eWxlLmRpc3BsYXkgPSBcIlwiO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoaWRlTGludGVyKCkge1xyXG4gICAgXy5lYWNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJsaW50ZXItYm90dG9tLXRhYlwiKSwgKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7ZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7fSk7XHJcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHtlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjt9KTtcclxuICAgIGNvbnN0IHBhbmVsID0gPEhUTUxFbGVtZW50PmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJsaW50ZXItcGFuZWxcIik7XHJcbiAgICBpZiAocGFuZWwpXHJcbiAgICAgICAgcGFuZWwuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG59XHJcblxyXG5sZXQgc2hvd0hpZGRlbkRpYWdub3N0aWNzID0gdHJ1ZTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0KGxpbnRlcjogeyBnZXRFZGl0b3JMaW50ZXI6IChlZGl0b3I6IEF0b20uVGV4dEVkaXRvcikgPT4geyBsaW50OiAoc2hvdWxkTGludDogYm9vbGVhbikgPT4gdm9pZCB9IH0pIHtcclxuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gICAgbGV0IGNkOiBDb21wb3NpdGVEaXNwb3NhYmxlO1xyXG4gICAgZGlzcG9zYWJsZS5hZGQoYXRvbS5jb25maWcub2JzZXJ2ZShcIm9tbmlzaGFycC1hdG9tLmhpZGVMaW50ZXJJbnRlcmZhY2VcIiwgaGlkZGVuID0+IHtcclxuICAgICAgICBpZiAoaGlkZGVuKSB7XHJcbiAgICAgICAgICAgIGNkID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICAgICAgICAgICAgZGlzcG9zYWJsZS5hZGQoY2QpO1xyXG5cclxuICAgICAgICAgICAgLy8gc2hvdyBsaW50ZXIgYnV0dG9uc1xyXG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiAheilcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoc2hvd0xpbnRlcikpO1xyXG5cclxuICAgICAgICAgICAgLy8gaGlkZSBsaW50ZXIgYnV0dG9uc1xyXG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiAhIXopXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKGhpZGVMaW50ZXIpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoY2QpIHtcclxuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGUucmVtb3ZlKGNkKTtcclxuICAgICAgICAgICAgICAgIGNkLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzaG93TGludGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSkpO1xyXG5cclxuICAgIGRpc3Bvc2FibGUuYWRkKGF0b20uY29uZmlnLm9ic2VydmUoXCJvbW5pc2hhcnAtYXRvbS5zaG93SGlkZGVuRGlhZ25vc3RpY3NcIiwgc2hvdyA9PiB7XHJcbiAgICAgICAgc2hvd0hpZGRlbkRpYWdub3N0aWNzID0gc2hvdztcclxuICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goKGVkaXRvcikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlZGl0b3JMaW50ZXIgPSBsaW50ZXIuZ2V0RWRpdG9yTGludGVyKGVkaXRvcik7XHJcbiAgICAgICAgICAgIGlmIChlZGl0b3JMaW50ZXIpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvckxpbnRlci5saW50KHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KSk7XHJcblxyXG4gICAgZGlzcG9zYWJsZS5hZGQoT21uaS5hY3RpdmVFZGl0b3IuZmlsdGVyKHogPT4gISF6KS50YWtlKDEpLmRlbGF5KDEwMDApLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgIE9tbmkud2hlbkVkaXRvckNvbm5lY3RlZChlKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goKGVkaXRvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVkaXRvckxpbnRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvckxpbnRlci5saW50KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pKTtcclxuXHJcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVySW5kaWUocmVnaXN0cnk6IEluZGllUmVnaXN0cnksIGRpc3Bvc2FibGU6IENvbXBvc2l0ZURpc3Bvc2FibGUpIHtcclxuICAgIGNvbnN0IGxpbnRlciA9IHJlZ2lzdHJ5LnJlZ2lzdGVyKHsgbmFtZTogXCJjI1wiIH0pO1xyXG4gICAgZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgICAgbGludGVyLFxyXG4gICAgICAgIE9tbmkuZGlhZ25vc3RpY3NcclxuICAgICAgICAgICAgLnN1YnNjcmliZShkaWFnbm9zdGljcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlczogTGludGVyTWVzc2FnZVtdID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGRpYWdub3N0aWNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3dIaWRkZW5EaWFnbm9zdGljcyB8fCBpdGVtLkxvZ0xldmVsICE9PSBcIkhpZGRlblwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWFwSW5kaWVWYWx1ZXMoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsaW50ZXIuc2V0TWVzc2FnZXMobWVzc2FnZXMpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgKTtcclxufVxyXG5cclxuIiwiaW1wb3J0IHsgT21uaSB9IGZyb20gXCIuLi9zZXJ2ZXIvb21uaVwiO1xuY29uc3QgUmFuZ2UgPSByZXF1aXJlKFwiYXRvbVwiKS5SYW5nZTtcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tIFwidHMtZGlzcG9zYWJsZXNcIjtcbmZ1bmN0aW9uIG1hcEluZGllVmFsdWVzKGVycm9yKSB7XG4gICAgY29uc3QgbGV2ZWwgPSBlcnJvci5Mb2dMZXZlbC50b0xvd2VyQ2FzZSgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IGxldmVsLFxuICAgICAgICB0ZXh0OiBgJHtlcnJvci5UZXh0fSBbJHtPbW5pLmdldEZyYW1ld29ya3MoZXJyb3IuUHJvamVjdHMpfV0gYCxcbiAgICAgICAgZmlsZVBhdGg6IGVycm9yLkZpbGVOYW1lLFxuICAgICAgICByYW5nZTogbmV3IFJhbmdlKFtlcnJvci5MaW5lLCBlcnJvci5Db2x1bW5dLCBbZXJyb3IuRW5kTGluZSwgZXJyb3IuRW5kQ29sdW1uXSlcbiAgICB9O1xufVxuZnVuY3Rpb24gc2hvd0xpbnRlcigpIHtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tdGFiXCIpLCAoZWxlbWVudCkgPT4geyBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIlwiOyB9KTtcbiAgICBfLmVhY2goZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImxpbnRlci1ib3R0b20tc3RhdHVzXCIpLCAoZWxlbWVudCkgPT4geyBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSBcIlwiOyB9KTtcbiAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJsaW50ZXItcGFuZWxcIik7XG4gICAgaWYgKHBhbmVsKVxuICAgICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gXCJcIjtcbn1cbmZ1bmN0aW9uIGhpZGVMaW50ZXIoKSB7XG4gICAgXy5lYWNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJsaW50ZXItYm90dG9tLXRhYlwiKSwgKGVsZW1lbnQpID0+IHsgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7IH0pO1xuICAgIF8uZWFjaChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwibGludGVyLWJvdHRvbS1zdGF0dXNcIiksIChlbGVtZW50KSA9PiB7IGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiOyB9KTtcbiAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJsaW50ZXItcGFuZWxcIik7XG4gICAgaWYgKHBhbmVsKVxuICAgICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG59XG5sZXQgc2hvd0hpZGRlbkRpYWdub3N0aWNzID0gdHJ1ZTtcbmV4cG9ydCBmdW5jdGlvbiBpbml0KGxpbnRlcikge1xuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIGxldCBjZDtcbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uaGlkZUxpbnRlckludGVyZmFjZVwiLCBoaWRkZW4gPT4ge1xuICAgICAgICBpZiAoaGlkZGVuKSB7XG4gICAgICAgICAgICBjZCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgICAgICAgICBkaXNwb3NhYmxlLmFkZChjZCk7XG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHogPT4gIXopXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShzaG93TGludGVyKSk7XG4gICAgICAgICAgICBjZC5hZGQoT21uaS5hY3RpdmVFZGl0b3JcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHogPT4gISF6KVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoaGlkZUxpbnRlcikpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNkKSB7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZS5yZW1vdmUoY2QpO1xuICAgICAgICAgICAgICAgIGNkLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNob3dMaW50ZXIoKTtcbiAgICAgICAgfVxuICAgIH0pKTtcbiAgICBkaXNwb3NhYmxlLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKFwib21uaXNoYXJwLWF0b20uc2hvd0hpZGRlbkRpYWdub3N0aWNzXCIsIHNob3cgPT4ge1xuICAgICAgICBzaG93SGlkZGVuRGlhZ25vc3RpY3MgPSBzaG93O1xuICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xuICAgICAgICAgICAgaWYgKGVkaXRvckxpbnRlcikge1xuICAgICAgICAgICAgICAgIGVkaXRvckxpbnRlci5saW50KHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KSk7XG4gICAgZGlzcG9zYWJsZS5hZGQoT21uaS5hY3RpdmVFZGl0b3IuZmlsdGVyKHogPT4gISF6KS50YWtlKDEpLmRlbGF5KDEwMDApLnN1YnNjcmliZSgoZSkgPT4ge1xuICAgICAgICBPbW5pLndoZW5FZGl0b3JDb25uZWN0ZWQoZSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkuZm9yRWFjaCgoZWRpdG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZWRpdG9yTGludGVyID0gbGludGVyLmdldEVkaXRvckxpbnRlcihlZGl0b3IpO1xuICAgICAgICAgICAgICAgIGlmIChlZGl0b3JMaW50ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yTGludGVyLmxpbnQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckluZGllKHJlZ2lzdHJ5LCBkaXNwb3NhYmxlKSB7XG4gICAgY29uc3QgbGludGVyID0gcmVnaXN0cnkucmVnaXN0ZXIoeyBuYW1lOiBcImMjXCIgfSk7XG4gICAgZGlzcG9zYWJsZS5hZGQobGludGVyLCBPbW5pLmRpYWdub3N0aWNzXG4gICAgICAgIC5zdWJzY3JpYmUoZGlhZ25vc3RpY3MgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGRpYWdub3N0aWNzKSB7XG4gICAgICAgICAgICBpZiAoc2hvd0hpZGRlbkRpYWdub3N0aWNzIHx8IGl0ZW0uTG9nTGV2ZWwgIT09IFwiSGlkZGVuXCIpIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1hcEluZGllVmFsdWVzKGl0ZW0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsaW50ZXIuc2V0TWVzc2FnZXMobWVzc2FnZXMpO1xuICAgIH0pKTtcbn1cbiJdfQ==
